<script lang="ts">
    let socketUrl = `${import.meta.env.VITE_SOCKET}/ws/update_config`;
    let ws = new WebSocket(socketUrl);
    let prompt = "A cat";
    let width = 512;
    let height = 512;
    let guidance_scale = 0;
    let realtime = false;
    let seed = -1;
    let camera = false;
    let cameraCanvas: HTMLCanvasElement;
    let videoStream: MediaStream | null = null;
    let videoElement: HTMLVideoElement;

    ws.onopen = () => {
        console.log("WebSocket connection established");
    };

    async function startCamera() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = videoStream;
            videoElement.play();
        } catch (error) {
            console.error("Failed to access camera:", error);
        }
    }

    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }

    function captureImage() {
        const context = cameraCanvas.getContext('2d');
        if (context && videoElement) {
            context.drawImage(videoElement, 0, 0, cameraCanvas.width, cameraCanvas.height);
            return cameraCanvas.toDataURL('image/png');
        }
        return null;
    }

    function sendConfig(live: boolean) {
        if (live && ws.readyState === WebSocket.OPEN) {
            let configData: any = {
                prompt: prompt,
                width: width,
                height: height,
                guidance_scale: guidance_scale,
                seed: seed
            };
            
            if (camera) {
                const initImage = captureImage();
                if (initImage) {
                    configData.init_image = initImage;
                }
            }

            ws.send(JSON.stringify(configData));
        }
    }

    function handleCameraToggle() {
        console.log("Camera toggled");
        if (camera) {
            startCamera();
        } else {
            stopCamera();
        }
    }

    $: {
        if (realtime) {
            sendConfig(true);
        }
    }
</script>

<section>
    <h1>Config</h1>
    <p>Config page content</p>
    <div>
        <input type="checkbox" bind:checked={realtime} class="checkbox" />
        <label for="realtime">Realtime</label>
    </div>
    <div>
        <label for="seed">Seed</label>
        <input type="number" bind:value={seed} on:input={() => sendConfig(realtime)} />
    </div>
    <div>
        <label for="prompt">Prompt</label>
        <input type="text" bind:value={prompt} on:input={() => sendConfig(realtime)} />
    </div>
    <div>
        <label for="width">Width {width}</label>
        <input type="range" min="256" max="1024" step="64" bind:value={width} class="range range-primary"  on:input={() => sendConfig(realtime)} />
    </div>
    <div>
        <label for="height">Height {height}</label>
        <input type="range" min="256" max="1024" step="64" bind:value={height} class="range range-primary" on:input={() => sendConfig(realtime)} />
    </div>
    <div>
        <label for="guidance_scale">Guidance Scale</label>
        <input type="range" min="0" max="10" step="1" bind:value={guidance_scale} class="range range-primary" on:input={() => sendConfig(realtime)} />
    </div>
    <div>
        <input type="checkbox" bind:checked={camera} class="checkbox" on:change={handleCameraToggle} />
        <label for="camera">Camera</label>
        <video bind:this={videoElement} width="512" height="512" autoplay hidden></video>
        <canvas bind:this={cameraCanvas} width="512" height="512"></canvas>
    </div>
</section>
